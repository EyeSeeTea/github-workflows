name: "Build size check"

on:
  workflow_call:
    inputs:
      branch_name:
        description: "Branch where to fetch bunlemonrc"
        required: false
        default: "master"
        type: string
      runner:
        description: "Specify runner. Defaults to checking visibility"
        required: false
        default: "ubuntu-latest"
        type: string

jobs:
  build-size-check:
    name: Bundlemon Build Size Check
    runs-on: ${{ inputs.runner }}

    steps:
      # Check out base (target) branch at the commit where the PR branched off
      - name: Check out base branch
        uses: actions/checkout@v4

      - name: Install apt libraries
        run: sudo apt install gettext -y

      # Check if .bundlemonrc exists in the caller repo
      - name: Check for .bundlemonrc in caller repo
        id: check_bundlemonrc
        run: |
          if [ -f ".bundlemonrc" ]; then
            echo "‚úÖ Using .bundlemonrc from caller repo"
            echo "USE_CALLER_CONFIG=true" >> $GITHUB_ENV
          else
            echo "‚ö†Ô∏è No .bundlemonrc in caller repo, will try fetching from workflow repo"
            echo "USE_CALLER_CONFIG=false" >> $GITHUB_ENV
          fi

      # Fetch .bundlemonrc from the workflow repo branch if needed
      - name: Fetch .bundlemonrc from reusable workflow repo
        if: env.USE_CALLER_CONFIG == 'false'
        run: |
          echo "Downloading .bundlemonrc from EyeSeeTea/github-workflows (branch: ${{ inputs.branch_name }})"
          BUNDLEMON_URL="https://raw.githubusercontent.com/EyeSeeTea/github-workflows/${{ inputs.branch_name }}/.bundlemonrc"
          if curl --silent --fail --output .bundlemonrc "$BUNDLEMON_URL"; then
            echo "‚úÖ Successfully downloaded .bundlemonrc"
          else
            echo "‚ùå Failed to fetch .bundlemonrc from the reusable workflow repo. Skipping build size check."
            exit 1
          fi

      # Set up Node.js
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'  # Use the Node.js version specified in .nvmrc
          cache: 'yarn'

      # Install and build
      - name: Install and build
        run: |
          yarn install --frozen-lockfile --silent
          yarn build

      #install bundlemon
      - name: Install dependencies (including BundleMon)
        run: |
          if ! npx --no-install bundlemon --version; then
            echo "‚ö†Ô∏è BundleMon not found, installing..."
            yarn add bundlemon --no-lockfile --silent
          else
            echo "‚úÖ BundleMon is already installed"
          fi
          

      - name: Run BundleMon
        id: bundlemon
        run: |
          npx bundlemon --json > bundlemon-report.json || true

      - name: Format BundleMon Report
        id: format_report
        run: |
          # Extract files summary
          FILE_RESULTS=$(jq -r '
            .results | map(
              (if .sizeDiffLabel | test("^[+-]0B$") then "‚úÖ No change" 
               else (if .sizeDiffLabel | test("^[+]") then "‚ö†Ô∏è Increased" else "‚úÖ Decreased" end) end) as $status |
              "| \($status) | \(.filePath) | \(.sizeDiffLabel) | \(.maxSizeLabel // "N/A") |"
            ) | join("\n")
          ' bundlemon-report.json)
          
          # Extract added files
          FILES_ADDED=$(jq -r '
            .results | map(select(.sizeDiffLabel | test("^[+]"))) | map(
              "| :white_check_mark: | \(.filePath) | \(.sizeDiffLabel) | \(.maxSizeLabel // "N/A") |"
            ) | join("\n")
          ' bundlemon-report.json)
          
          # Extract groups summary
          GROUPS_ADDED=$(jq -r '
            .groups | map(
              "| :white_check_mark: | \(.pattern) | \(.sizeDiffLabel // "+0B") | \(.maxSizeLabel // "N/A") |"
            ) | join("\n")
          ' bundlemon-report.json)
          
          # Default values if empty
          if [ -z "$FILE_RESULTS" ]; then FILE_RESULTS="‚úÖ No change in files bundle size"; fi
          if [ -z "$FILES_ADDED" ]; then FILES_ADDED="‚úÖ No new files added"; fi
          if [ -z "$GROUPS_ADDED" ]; then GROUPS_ADDED="‚úÖ No new groups added"; fi
          
          # Store in GitHub Actions outputs
          echo "file_results<<EOF" >> $GITHUB_ENV
          echo "$FILE_RESULTS" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          
          echo "files_added<<EOF" >> $GITHUB_ENV
          echo "$FILES_ADDED" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          
          echo "groups_added<<EOF" >> $GITHUB_ENV
          echo "$GROUPS_ADDED" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

          - name: Comment PR with BundleMon Summary
              if: github.event_name == 'pull_request'
              uses: mshick/add-pr-comment@v2
              with:
                message: |
                  <!-- bundlemon -->
                  ## üìä BundleMon Report
          
                  ${{ env.file_results }}
          
                  <details open>
                  <summary>üìÇ Groups Added</summary>
          
                  Status | Path | Size | Limits
                  :------------: | ------------ | :------------: | :------------:
                  ${{ env.groups_added }}
          
                  </details>
          
                  <details open>
                  <summary>üìÇ Files Added</summary>
          
                  Status | Path | Size | Limits
                  :------------: | ------------ | :------------: | :------------:
                  ${{ env.files_added }}
          
                  </details>
                repo-token: ${{ secrets.GITHUB_TOKEN }}
                allow-repeats: false