name: "Build size check"

on:
  workflow_call:
    inputs:
      branch_name:
        description: "Branch where to fetch bunlemonrc"
        required: false
        default: "master"
        type: string
      runner:
        description: "Specify runner. Defaults to checking visibility"
        required: false
        default: "ubuntu-latest"
        type: string

jobs:
  build-size-check:
    name: Bundlemon Build Size Check
    runs-on: ${{ inputs.runner }}

    steps:
      # Check out base (target) branch at the commit where the PR branched off
      - name: Check out base branch
        uses: actions/checkout@v4

      - name: Install apt libraries
        run: sudo apt install gettext -y

      # Check if .bundlemonrc exists in the caller repo
      - name: Check for .bundlemonrc in caller repo
        id: check_bundlemonrc
        run: |
          if [ -f ".bundlemonrc" ]; then
            echo "âœ… Using .bundlemonrc from caller repo"
            echo "USE_CALLER_CONFIG=true" >> $GITHUB_ENV
          else
            echo "âš ï¸ No .bundlemonrc in caller repo, will try fetching from workflow repo"
            echo "USE_CALLER_CONFIG=false" >> $GITHUB_ENV
          fi

      # Fetch .bundlemonrc from the workflow repo branch if needed
      - name: Fetch .bundlemonrc from reusable workflow repo
        if: env.USE_CALLER_CONFIG == 'false'
        run: |
          echo "Downloading .bundlemonrc from EyeSeeTea/github-workflows (branch: ${{ inputs.branch_name }})"
          BUNDLEMON_URL="https://raw.githubusercontent.com/EyeSeeTea/github-workflows/${{ inputs.branch_name }}/.bundlemonrc"
          if curl --silent --fail --output .bundlemonrc "$BUNDLEMON_URL"; then
            echo "âœ… Successfully downloaded .bundlemonrc"
          else
            echo "âŒ Failed to fetch .bundlemonrc from the reusable workflow repo. Skipping build size check."
            exit 1
          fi

      # Set up Node.js
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'  # Use the Node.js version specified in .nvmrc
          cache: 'yarn'

      # Install and build
      - name: Install and build
        run: |
          yarn install --frozen-lockfile --silent
          yarn build

      #install bundlemon
      - name: Install dependencies (including BundleMon)
        run: |
          if ! npx --no-install bundlemon --version; then
            echo "âš ï¸ BundleMon not found, installing..."
            yarn add bundlemon --no-lockfile --silent
          else
            echo "âœ… BundleMon is already installed"
          fi


      - name: Run BundleMon
        id: bundlemon
        run: |
          npx bundlemon > bundlemon_raw_output.txt
          

      - name: Format BundleMon Output
        run: |
          export PATH=$PATH:/usr/bin:/bin
          echo "## ðŸ“¦ BundleMon Report" > bundlemon_comment.txt
          
          # Start table
          echo "" >> bundlemon_comment.txt
          echo "| Status | Path | Size | Limit |" >> bundlemon_comment.txt
          echo "|:------:|------|:----:|:-----:|" >> bundlemon_comment.txt
          
          # Extract relevant lines, only those below "Groups:"
          awk '/Groups:/ { found=1; next } found && /\[PASS\]|\[WARN\]|\[FAIL\]/ {
            status = ($1 == "[PASS]") ? "âœ…" : ($1 == "[WARN]") ? "âš ï¸" : "âŒ";
            print status " | " $2 " | " $3 " | " $5
          }' bundlemon_raw_output.txt >> bundlemon_comment.txt
          
          # Add collapsible raw output
          echo "" >> bundlemon_comment.txt
          echo "<details>" >> bundlemon_comment.txt
          echo "<summary>Raw Output</summary>" >> bundlemon_comment.txt
          echo "" >> bundlemon_comment.txt
          echo '```' >> bundlemon_comment.txt
          cat bundlemon_raw_output.txt >> bundlemon_comment.txt
          echo '```' >> bundlemon_comment.txt
          echo "</details>" >> bundlemon_comment.txt

        # Post comment on PR if workflow is triggered by a PR
      - name: Post PR Comment
        if: github.event_name == 'pull_request'
        run: |
          gh pr comment ${{ github.event.pull_request.number }} --body "$(cat bundlemon_comment.txt)"
        env:
          GH_TOKEN: ${{ github.token }}