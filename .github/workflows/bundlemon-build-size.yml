name: "Build size check"

on:
  workflow_call:
    inputs:
      branch_name:
        description: "Branch where to fetch bunlemonrc"
        required: false
        default: "master"
        type: string
      runner:
        description: "Specify runner. Defaults to checking visibility"
        required: false
        default: "ubuntu-latest"
        type: string

jobs:
  build-size-check:
    name: Bundlemon Build Size Check
    runs-on: ${{ inputs.runner }}

    steps:
      # Check out base (target) branch at the commit where the PR branched off
      - name: Check out base branch
        uses: actions/checkout@v4

      - name: Install apt libraries
        run: sudo apt install gettext -y

      # Check if .bundlemonrc exists in the caller repo
      - name: Check for .bundlemonrc in caller repo
        id: check_bundlemonrc
        run: |
          if [ -f ".bundlemonrc" ]; then
            echo "âœ… Using .bundlemonrc from caller repo"
            echo "USE_CALLER_CONFIG=true" >> $GITHUB_ENV
          else
            echo "âš ï¸ No .bundlemonrc in caller repo, will try fetching from workflow repo"
            echo "USE_CALLER_CONFIG=false" >> $GITHUB_ENV
          fi

      # Fetch .bundlemonrc from the workflow repo branch if needed
      - name: Fetch .bundlemonrc from reusable workflow repo
        if: env.USE_CALLER_CONFIG == 'false'
        run: |
          echo "Downloading .bundlemonrc from EyeSeeTea/github-workflows (branch: ${{ inputs.branch_name }})"
          BUNDLEMON_URL="https://raw.githubusercontent.com/EyeSeeTea/github-workflows/${{ inputs.branch_name }}/.bundlemonrc"
          if curl --silent --fail --output .bundlemonrc "$BUNDLEMON_URL"; then
            echo "âœ… Successfully downloaded .bundlemonrc"
          else
            echo "âŒ Failed to fetch .bundlemonrc from the reusable workflow repo. Skipping build size check."
            exit 1
          fi

      # Set up Node.js
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'  # Use the Node.js version specified in .nvmrc
          cache: 'yarn'

      # Install and build
      - name: Install and build
        run: |
          yarn install --frozen-lockfile --silent
          yarn build

      #install bundlemon
      - name: Install dependencies (including BundleMon)
        run: |
          if ! npx --no-install bundlemon --version; then
            echo "âš ï¸ BundleMon not found, installing..."
            yarn add bundlemon --no-lockfile --silent
          else
            echo "âœ… BundleMon is already installed"
          fi
          

      - name: Format BundleMon Output
        run: |
          echo "### ðŸ“¦ **BundleMon Report**" > bundlemon_comment.txt
          if grep -q "\[PASS\]" bundlemon_raw_output.txt; then
          echo "âœ… **No significant changes in bundle size!** ðŸŽ‰" >> bundlemon_comment.txt
          elif grep -q "\[WARN\]" bundlemon_raw_output.txt; then
          echo "âš ï¸ **Some files have increased in size but are within limits.**" >> bundlemon_comment.txt
          elif grep -q "\[FAIL\]" bundlemon_raw_output.txt; then
          echo "âŒ **Some files exceeded the allowed size limit! Please review.**" >> bundlemon_comment.txt
          fi
          echo "\`\`\`" >> bundlemon_comment.txt
          grep -E "Groups:|Files:|\[PASS\]|\[WARN\]|\[FAIL\]" bundlemon_raw_output.txt >> bundlemon_comment.txt
          echo "\`\`\`" >> bundlemon_comment.txt

        # Post comment on PR if workflow is triggered by a PR
      - name: Post PR Comment
        if: github.event_name == 'pull_request'
        run: |
          gh pr comment ${{ github.event.pull_request.number }} --body "$(cat bundlemon_comment.txt)"
        env:
          GH_TOKEN: ${{ github.token }}